<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Password Request Batch 5-JV</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f6f8;
  padding: 20px;
}
.container {
  max-width: 420px;
  margin: auto;
  background: #ffffff;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
}
h2 {
  text-align: center;
}
label {
  font-weight: bold;
}
input[type="text"], input[type="tel"] {
  width: 100%;
  padding: 10px;
  margin: 5px 0 15px;
  border: 1px solid #ccc;
  border-radius: 5px;
  text-transform: uppercase;
}
.consent {
  font-size: 13px;
  margin-bottom: 15px;
}
button {
  width: 100%;
  padding: 12px;
  background: #25D366;
  color: white;
  border: none;
  border-radius: 5px;
  font-size: 16px;
  cursor: not-allowed;
  opacity: 0.6;
}
button.enabled {
  cursor: pointer;
  opacity: 1;
}
.note {
  font-size: 12px;
  color: #666;
  text-align: center;
  margin-top: 10px;
}

/* ===== SUCCESS ANIMATION ===== */
.successBox {
  display: none;
  text-align: center;
}
.checkmark {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  border: 4px solid #4CAF50;
  margin: 0 auto 15px;
  position: relative;
  animation: pop 0.4s ease-out;
}
.checkmark svg {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}
@keyframes pop {
  0% { transform: scale(0); }
  100% { transform: scale(1); }
}
.ref {
  font-weight: bold;
  margin-top: 10px;
}
</style>

<script>
var IS_SUBMITTED = false;
</script>
</head>

<body>

<!-- FORM -->
<div class="container" id="formBox">
  <h2>üîê Password Request Batch 5-JV</h2>

  <form onsubmit="return validateAndSend();">
    <label>Company Name</label>
    <input type="text" id="company" required>

    <label>Director Name</label>
    <input type="text" id="director" required>

    <label>Company Reg. No</label>
    <input type="text" id="regno" required>

    <label>Contact No</label>
    <input type="tel" id="phone" placeholder="e.g. 60123456789" required>

    <div class="consent">
      <input type="checkbox" id="consent" onclick="toggleButton()">
      By submitting this request, I acknowledge that I am requesting access to a
      password issued by SINGER (M) SDN BHD / BERJAYA CREDIT SDN BHD and accept full
      responsibility for its use. Unauthorized access or misuse may result in further
      action.
    </div>

    <button type="submit" id="sendBtn" disabled>Send Request</button>
  </form>

  <div class="note">Request will be sent via WhatsApp</div>
</div>

<!-- SUCCESS -->
<div class="container successBox" id="successBox">
  <div class="checkmark">
    <svg width="40" height="30" viewBox="0 0 52 40">
      <path d="M2 20 L20 38 L50 2"
        fill="none"
        stroke="#4CAF50"
        stroke-width="6"
        stroke-linecap="round"
        stroke-linejoin="round"/>
    </svg>
  </div>
  <h2>Successfully Sent</h2>
  <div class="ref" id="refDisplay"></div>
  <p>Please wait for administrator response.</p>
</div>

<script>
function toggleButton() {
  var btn = document.getElementById("sendBtn");
  btn.disabled = !document.getElementById("consent").checked;
  btn.classList.toggle("enabled", !btn.disabled);
}

function generateReference() {
  var d = new Date();
  return "JV5-" +
    d.getFullYear() +
    String(d.getMonth()+1).padStart(2,"0") +
    String(d.getDate()).padStart(2,"0") + "-" +
    String(d.getHours()).padStart(2,"0") +
    String(d.getMinutes()).padStart(2,"0") +
    String(d.getSeconds()).padStart(2,"0");
}

async function getClientInfo() {
  let ip = "UNKNOWN";
  try {
    const r = await fetch("https://api.ipify.org?format=json");
    const j = await r.json();
    ip = j.ip;
  } catch(e){}

  return {
    ip: ip,
    ua: navigator.userAgent,
    platform: navigator.platform,
    lang: navigator.language
  };
}

function validateAndSend() {
  if (IS_SUBMITTED) return false;

  var phone = document.getElementById("phone").value.trim();
  if (!/^\d{10,15}$/.test(phone)) {
    alert("Please enter valid phone number (digits only).");
    return false;
  }

  if (!document.getElementById("consent").checked) return false;

  IS_SUBMITTED = true;
  var btn = document.getElementById("sendBtn");
  btn.disabled = true;
  btn.innerText = "Sending...";

  sendWhatsApp();
  return false;
}

async function sendWhatsApp() {
  var company = companyVal = document.getElementById("company").value.toUpperCase();
  var director = document.getElementById("director").value.toUpperCase();
  var regno = document.getElementById("regno").value.toUpperCase();
  var phone = document.getElementById("phone").value;
  var ref = generateReference();
  var time = new Date().toLocaleString();

  const client = await getClientInfo();

  var msg =
    "üîê PASSWORD REQUEST BATCH 5-JV\n\n" +
    "Time: " + time + "\n" +
    "Company: " + company + "\n" +
    "Director: " + director + "\n" +
    "Reg No: " + regno + "\n" +
    "Contact: " + phone + "\n\n" +
    "Consent:\n" +
    "By submitting this request, I acknowledge that I am requesting access to a " +
    "password issued by SINGER (M) SDN BHD / BERJAYA CREDIT SDN BHD and accept full " +
    "responsibility for its use. Unauthorized access or misuse may result in further " +
    "action.\n\n" +
    "Ref No: " + ref;

  window.open(
    "https://wa.me/60176701984?text=" + encodeURIComponent(msg),
    "_blank"
  );

  logToGoogleSheet(
    time, company, director, regno, phone, ref,
    client.ip, client.ua, client.platform, client.lang
  );

  document.getElementById("formBox").style.display = "none";
  document.getElementById("successBox").style.display = "block";
  document.getElementById("refDisplay").innerText = "Reference No: " + ref;
}

function logToGoogleSheet(time, company, director, regno, phone, ref, ip, ua, platform, lang) {

  const data = new URLSearchParams();
  data.append("time", time);
  data.append("company", company);
  data.append("director", director);
  data.append("regno", regno);
  data.append("phone", phone);
  data.append("ref", ref);
  data.append("ip", ip);
  data.append("ua", ua);
  data.append("platform", platform);
  data.append("lang", lang);

  fetch("https://script.google.com/macros/s/AKfycbykoT03ypKrrxL85aW054bji8zwEBZOZlZGX4S1lySMeNDi3QiQgYLJOFDVvVpWzj1b/exec", {
    method: "POST",
    body: data
  });
}

